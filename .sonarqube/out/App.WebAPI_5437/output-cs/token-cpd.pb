£
ED:\Dev\AspNetCoreTestes\App.WebAPI\AutoMapperConfig\MapperProvider.cs
	namespace 	
App
 
. 
WebAPI 
. 
AutoMapperConfig %
{ 
public 

class 
MapperProvider 
{ 
private 
readonly 
	Container "

_container# -
=. /
DependencyResolver0 B
.B C
ContainerFactoryC S
.S T
	ContainerT ]
;] ^
public 
IMapper 
	GetMapper  
(  !
)! "
{ 	
var 
mce 
= 
new )
MapperConfigurationExpression 7
(7 8
)8 9
;9 :
mce 
. "
ConstructServicesUsing &
(& '

_container' 1
.1 2
GetInstance2 =
)= >
;> ?
var 
profiles 
= 
typeof !
(! "%
ApplicationMappingProfile" ;
); <
.< =
Assembly= E
.E F
GetTypesF N
(N O
)O P
. 
Where 
( 
t 
=> 
typeof "
(" #
Profile# *
)* +
.+ ,
IsAssignableFrom, <
(< =
t= >
)> ?
)? @
. 
ToList 
( 
) 
; 
mce 
. 
AddProfiles 
( 
profiles $
)$ %
;% &
var 
mc 
= 
new 
MapperConfiguration ,
(, -
mce- 0
)0 1
;1 2
mc   
.   &
AssertConfigurationIsValid   )
(  ) *
)  * +
;  + ,
IMapper"" 
m"" 
="" 
new"" 
Mapper"" "
(""" #
mc""# %
,""% &
t""' (
=>"") +

_container"", 6
.""6 7
GetInstance""7 B
(""B C
t""C D
)""D E
)""E F
;""F G
return$$ 
m$$ 
;$$ 
}%% 	
}&& 
}'' £*
@D:\Dev\AspNetCoreTestes\App.WebAPI\Controllers\AuthController.cs
	namespace 	
App
 
. 
WebAPI 
. 
Controllers  
{ 
[ 
	Authorize 
] 
[ 
Produces 
( 
$str  
)  !
]! "
[ 
Route 

(
 
$str 
) 
] 
public 

class 
AuthController 
:  !

Controller" ,
{ 
private $
ILoginApplicationService (
_loginService) 6
;6 7
private 
IConfigurationRoot "
_config# *
;* +
public 
AuthController 
( $
ILoginApplicationService 6
loginService7 C
,C D
IConfigurationRootE W
configX ^
)^ _
{   	
_loginService!! 
=!! 
loginService!! (
;!!( )
_config"" 
="" 
config"" 
;"" 
}$$ 	
[++ 	
HttpPost++	 
]++ 
[,, 	
AllowAnonymous,,	 
],, 
[-- 	 
ProducesResponseType--	 
(-- 
$num-- !
)--! "
]--" #
[.. 	 
ProducesResponseType..	 
(.. 
$num.. !
)..! "
].." #
public// 
IActionResult// 
Login// "
(//" #
[//# $
FromBody//$ ,
]//, -
LoginViewModel//. <
login//= B
)//B C
{00 	
if11 
(11 
login11 
==11 
null11 
)11 
return22 

BadRequest22 !
(22! "
$str22" >
)22> ?
;22? @
var44 
user44 
=44 
_loginService44 $
.44$ %
Login44% *
(44* +
login44+ 0
.440 1
Email441 6
,446 7
login448 =
.44= >
Senha44> C
)44C D
;44D E
if66 
(66 
user66 
!=66 
null66 
)66 
{77 
var88 
claims88 
=88 
new88  
[88  !
]88! "
{99 
new:: 
Claim:: 
(:: #
JwtRegisteredClaimNames:: 5
.::5 6
Sub::6 9
,::9 :
user::; ?
.::? @
Email::@ E
)::E F
,::F G
new;; 
Claim;; 
(;; #
JwtRegisteredClaimNames;; 5
.;;5 6
Jti;;6 9
,;;9 :
user;;; ?
.;;? @
Id;;@ B
.;;B C
ToString;;C K
(;;K L
);;L M
);;M N
,;;N O
new<< 
Claim<< 
(<< #
JwtRegisteredClaimNames<< 5
.<<5 6
Email<<6 ;
,<<; <
user<<= A
.<<A B
Email<<B G
)<<G H
,<<H I
new== 
Claim== 
(== #
JwtRegisteredClaimNames== 5
.==5 6
	GivenName==6 ?
,==? @
user==A E
.==E F
Nome==F J
)==J K
,==K L
new>> 
Claim>> 
(>> 
$str>> '
,>>' (
user>>) -
.>>- .
Perfil>>. 4
.>>4 5
ToString>>5 =
(>>= >
)>>> ?
)>>? @
,>>@ A
}?? 
;?? 
varBB 
keyBB 
=BB 
newBB  
SymmetricSecurityKeyBB 2
(BB2 3
EncodingBB3 ;
.BB; <
UTF8BB< @
.BB@ A
GetBytesBBA I
(BBI J
_configBBJ Q
[BBQ R
$strBBR ^
]BB^ _
)BB_ `
)BB` a
;BBa b
varCC 
credsCC 
=CC 
newCC 
SigningCredentialsCC  2
(CC2 3
keyCC3 6
,CC6 7
SecurityAlgorithmsCC8 J
.CCJ K

HmacSha256CCK U
)CCU V
;CCV W
varEE 
tokenEE 
=EE 
newEE 
JwtSecurityTokenEE  0
(EE0 1
_configEE1 8
[EE8 9
$strEE9 H
]EEH I
,EEI J
_configFF 
[FF 
$strFF )
]FF) *
,FF* +
claimsGG 
,GG 
expiresHH 
:HH 
DateTimeHH #
.HH# $
NowHH$ '
.HH' (

AddMinutesHH( 2
(HH2 3
$numHH3 5
)HH5 6
,HH6 7
signingCredentialsII $
:II$ %
credsII& +
)II+ ,
;II, -
returnLL 
OkLL 
(LL 
newLL 
{MM 
tokenNN 
=NN 
newNN #
JwtSecurityTokenHandlerNN  7
(NN7 8
)NN8 9
.NN9 :

WriteTokenNN: D
(NND E
tokenNNE J
)NNJ K
,NNK L

expirationOO 
=OO  
tokenOO! &
.OO& '
ValidToOO' .
}PP 
)PP 
;PP 
}QQ 
throwSS 
newSS $
UserLoginFailedExceptionSS .
(SS. /
)SS/ 0
;SS0 1
}TT 	
}UU 
}VV û
@D:\Dev\AspNetCoreTestes\App.WebAPI\Controllers\BaseController.cs
	namespace 	
App
 
. 
WebAPI 
. 
Controllers  
{		 
public 

abstract 
class 
BaseController (
:) *

Controller+ 5
{ 
public 
UsuarioViewModel 
Usuario  '
=>( *
ObterUsuario+ 7
(7 8
)8 9
;9 :
private 
UsuarioViewModel  
_usuario! )
;) *
private 
UsuarioViewModel  
ObterUsuario! -
(- .
). /
{ 	
if 
( 
_usuario 
!= 
null  
)  !
return 
_usuario 
;  
var 
usuario 
= 
new 
UsuarioViewModel .
(. /
)/ 0
;0 1
var 
identity 
= 
User 
.  
Identity  (
as) +
ClaimsIdentity, :
;: ;
if   
(   
identity   
==   
null    
)    !
return!! 
null!! 
;!! 
var## 
claims## 
=## 
identity## !
.##! "
Claims##" (
.##( )
ToList##) /
(##/ 0
)##0 1
;##1 2
var$$ 
id$$ 
=$$ 
GetClaimValue$$ "
($$" #
claims$$# )
,$$) *#
JwtRegisteredClaimNames$$+ B
.$$B C
Jti$$C F
)$$F G
;$$G H
usuario&& 
.&& 
Id&& 
=&& 
int&& 
.&& 
Parse&& "
(&&" #
id&&# %
)&&% &
;&&& '
usuario'' 
.'' 
Nome'' 
='' 
GetClaimValue'' (
(''( )
claims'') /
,''/ 0

ClaimTypes''1 ;
.''; <
	GivenName''< E
)''E F
;''F G
usuario(( 
.(( 
Email(( 
=(( 
GetClaimValue(( )
((() *
claims((* 0
,((0 1

ClaimTypes((2 <
.((< =
Email((= B
)((B C
;((C D
usuario)) 
.)) 
Perfil)) 
=)) 
GetClaimValue)) *
())* +
claims))+ 1
,))1 2
$str))3 <
)))< =
;))= >
_usuario++ 
=++ 
usuario++ 
;++ 
return,, 
_usuario,, 
;,, 
}-- 	
private// 
string// 
GetClaimValue// $
(//$ %
IList//% *
<//* +
Claim//+ 0
>//0 1
claims//2 8
,//8 9
string//: @
type//A E
)//E F
{00 	
return11 
claims11 
.11 
FirstOrDefault11 (
(11( )
c11) *
=>11+ -
c11. /
.11/ 0
Type110 4
==115 7
type118 <
)11< =
?11= >
.11> ?
Value11? D
;11D E
}22 	
}33 
}44 æ%
DD:\Dev\AspNetCoreTestes\App.WebAPI\Controllers\ClientesController.cs
	namespace 	
App
 
. 
WebAPI 
. 
Controllers  
{		 
[ 
	Authorize 
] 
[ 
Route 

(
 
$str 
) 
] 
public 

class 
ClientesController #
:$ %
BaseController& 4
{ 
private &
IClienteApplicationService *
_appService+ 6
{7 8
get9 <
;< =
}> ?
public 
ClientesController !
(! "&
IClienteApplicationService" <

appService= G
)G H
{ 	
_appService 
= 

appService $
;$ %
} 	
["" 	
HttpGet""	 
]"" 
[## 	 
ProducesResponseType##	 
(## 
typeof## $
(##$ %
IList##% *
<##* +
Cliente##+ 2
>##2 3
)##3 4
,##4 5
$num##6 9
)##9 :
]##: ;
public$$ 
IActionResult$$ 
Get$$  
($$  !
int$$! $
pagina$$% +
,$$+ ,
int$$- 0
	porPagina$$1 :
)$$: ;
{%% 	
return&& 
Ok&& 
(&& 
_appService&& !
.&&! "
ListarTodos&&" -
(&&- .
pagina&&. 4
,&&4 5
	porPagina&&6 ?
)&&? @
)&&@ A
;&&A B
}'' 	
[.. 	
HttpGet..	 
(.. 
$str.. 
).. 
].. 
[// 	 
ProducesResponseType//	 
(// 
typeof// $
(//$ %
Cliente//% ,
)//, -
,//- .
$num/// 2
)//2 3
]//3 4
[00 	 
ProducesResponseType00	 
(00 
$num00 !
)00! "
]00" #
public11 
IActionResult11 
Get11  
(11  !
int11! $
id11% '
)11' (
{22 	
return33 
Ok33 
(33 
_appService33 !
.33! "
Obter33" '
(33' (
id33( *
)33* +
)33+ ,
;33, -
}44 	
[;; 	
HttpPost;;	 
];; 
[<< 	 
ProducesResponseType<<	 
(<< 
typeof<< $
(<<$ %
Cliente<<% ,
)<<, -
,<<- .
$num<</ 2
)<<2 3
]<<3 4
[== 	 
ProducesResponseType==	 
(== 
$num== !
)==! "
]==" #
public>> 
IActionResult>> 
Post>> !
(>>! "
[>>" #
FromBody>># +
]>>+ ,
ClienteInput>>- 9
cliente>>: A
)>>A B
{?? 	
_appService@@ 
.@@ 
	Adicionar@@ !
(@@! "
cliente@@" )
)@@) *
;@@* +
returnAA 
OkAA 
(AA 
)AA 
;AA 
}BB 	
[JJ 	
HttpPutJJ	 
(JJ 
$strJJ 
)JJ 
]JJ 
[KK 	 
ProducesResponseTypeKK	 
(KK 
$numKK !
)KK! "
]KK" #
[LL 	 
ProducesResponseTypeLL	 
(LL 
$numLL !
)LL! "
]LL" #
[MM 	 
ProducesResponseTypeMM	 
(MM 
$numMM !
)MM! "
]MM" #
publicNN 
IActionResultNN 
PutNN  
(NN  !
intNN! $
idNN% '
,NN' (
[NN) *
FromBodyNN* 2
]NN2 3
ClienteInputNN3 ?
clienteNN@ G
)NNG H
{OO 	
_appServicePP 
.PP 
	AtualizarPP !
(PP! "
idPP" $
,PP$ %
clientePP& -
)PP- .
;PP. /
returnQQ 
OkQQ 
(QQ 
)QQ 
;QQ 
}RR 	
[YY 	

HttpDeleteYY	 
(YY 
$strYY 
)YY 
]YY 
[ZZ 	 
ProducesResponseTypeZZ	 
(ZZ 
$numZZ !
)ZZ! "
]ZZ" #
[[[ 	 
ProducesResponseType[[	 
([[ 
$num[[ !
)[[! "
][[" #
public\\ 
IActionResult\\ 
Delete\\ #
(\\# $
int\\$ '
id\\( *
)\\* +
{]] 	
_appService^^ 
.^^ 
Excluir^^ 
(^^  
id^^  "
)^^" #
;^^# $
return__ 
Ok__ 
(__ 
)__ 
;__ 
}`` 	
}aa 
}bb ¹&
DD:\Dev\AspNetCoreTestes\App.WebAPI\Controllers\UsuariosController.cs
	namespace 	
App
 
. 
WebAPI 
. 
Controllers  
{		 
[ 
	Authorize 
( 
Policy 
= 
$str )
)) *
]* +
[ 
Route 

(
 
$str 
) 
] 
public 

class 
UsuariosController #
:$ %
BaseController& 4
{ 
private &
IUsuarioApplicationService *
_appService+ 6
{7 8
get9 <
;< =
}> ?
public 
UsuariosController !
(! "&
IUsuarioApplicationService" <

appService= G
)G H
{ 	
_appService 
= 

appService $
;$ %
} 	
["" 	
HttpGet""	 
]"" 
[## 	 
ProducesResponseType##	 
(## 
typeof## $
(##$ %
IList##% *
<##* +
Usuario##+ 2
>##2 3
)##3 4
,##4 5
$num##6 9
)##9 :
]##: ;
public$$ 
IActionResult$$ 
Get$$  
($$  !
int$$! $
pagina$$% +
,$$+ ,
int$$- 0
	porPagina$$1 :
)$$: ;
{%% 	
return&& 
Ok&& 
(&& 
_appService&& !
.&&! "
ListarTodos&&" -
(&&- .
pagina&&. 4
,&&4 5
	porPagina&&6 ?
)&&? @
)&&@ A
;&&A B
}'' 	
[.. 	
HttpGet..	 
(.. 
$str.. 
).. 
].. 
[// 	 
ProducesResponseType//	 
(// 
typeof// $
(//$ %
Usuario//% ,
)//, -
,//- .
$num/// 2
)//2 3
]//3 4
[00 	 
ProducesResponseType00	 
(00 
$num00 !
)00! "
]00" #
public11 
IActionResult11 
Get11  
(11  !
int11! $
id11% '
)11' (
{22 	
return33 
Ok33 
(33 
_appService33 !
.33! "
Obter33" '
(33' (
id33( *
)33* +
)33+ ,
;33, -
}44 	
[;; 	
HttpPost;;	 
];; 
[<< 	 
ProducesResponseType<<	 
(<< 
typeof<< $
(<<$ %
Usuario<<% ,
)<<, -
,<<- .
$num<</ 2
)<<2 3
]<<3 4
[== 	 
ProducesResponseType==	 
(== 
$num== !
)==! "
]==" #
public>> 
IActionResult>> 
Post>> !
(>>! "
[>>" #
FromBody>># +
]>>+ ,
UsuarioInput>>- 9
usuario>>: A
)>>A B
{?? 	
_appService@@ 
.@@ 
	Adicionar@@ !
(@@! "
usuario@@" )
)@@) *
;@@* +
returnAA 
OkAA 
(AA 
)AA 
;AA 
}BB 	
[JJ 	
HttpPutJJ	 
(JJ 
$strJJ 
)JJ 
]JJ 
[KK 	 
ProducesResponseTypeKK	 
(KK 
$numKK !
)KK! "
]KK" #
[LL 	 
ProducesResponseTypeLL	 
(LL 
$numLL !
)LL! "
]LL" #
[MM 	 
ProducesResponseTypeMM	 
(MM 
$numMM !
)MM! "
]MM" #
publicNN 
IActionResultNN 
PutNN  
(NN  !
intNN! $
idNN% '
,NN' (
[NN) *
FromBodyNN* 2
]NN2 3
UsuarioInputNN3 ?
usuarioNN@ G
)NNG H
{OO 	
_appServicePP 
.PP 
	AtualizarPP !
(PP! "
idPP" $
,PP$ %
usuarioPP& -
)PP- .
;PP. /
returnQQ 
OkQQ 
(QQ 
)QQ 
;QQ 
}RR 	
[YY 	

HttpDeleteYY	 
(YY 
$strYY 
)YY 
]YY 
[ZZ 	 
ProducesResponseTypeZZ	 
(ZZ 
$numZZ !
)ZZ! "
]ZZ" #
[[[ 	 
ProducesResponseType[[	 
([[ 
$num[[ !
)[[! "
][[" #
public\\ 
IActionResult\\ 
Delete\\ #
(\\# $
int\\$ '
id\\( *
)\\* +
{]] 	
_appService^^ 
.^^ 
Excluir^^ 
(^^  
id^^  "
)^^" #
;^^# $
return__ 
Ok__ 
(__ 
)__ 
;__ 
}`` 	
}aa 
}bb ¸
ED:\Dev\AspNetCoreTestes\App.WebAPI\Middleware\ApiRequestMiddleware.cs
	namespace 	
App
 
. 
WebAPI 
. 

Middleware 
{ 
public

 

sealed

 
class

  
ApiRequestMiddleware

 ,
{ 
public 
async 
Task 
Invoke  
(  !
HttpContext! ,
context- 4
,4 5
Func6 :
<: ;
Task; ?
>? @
nextA E
)E F
{ 	
await 
next 
( 
) 
; 
} 	
} 
} ´
GD:\Dev\AspNetCoreTestes\App.WebAPI\Middleware\ErrorHandlerMiddleware.cs
	namespace 	
App
 
. 
WebAPI 
. 

Middleware 
{		 
public 

class "
ErrorHandlerMiddleware '
{ 
public 
async 
Task 
Invoke  
(  !
HttpContext! ,
context- 4
,4 5
Func6 :
<: ;
Task; ?
>? @
nextA E
)E F
{ 	
try 
{ 
await 
next 
( 
) 
; 
} 
catch 
( 
	Exception 
ex 
)  
{ 
await  
HandleExceptionAsync *
(* +
context+ 2
,2 3
ex4 6
)6 7
;7 8
} 
}   	
private"" 
static"" 
Task""  
HandleExceptionAsync"" 0
(""0 1
HttpContext""1 <
context""= D
,""D E
	Exception""F O
	exception""P Y
)""Y Z
{## 	
HttpStatusCode$$ 
code$$ 
;$$  
switch&& 
(&& 
	exception&& 
)&& 
{'' 
case(( 
NotFoundException(( &
nfEx((' +
:((+ ,
code)) 
=)) 
HttpStatusCode)) )
.))) *
NotFound))* 2
;))2 3
break** 
;** 
case++ %
FieldsValidationException++ .
fvEx++/ 3
:++3 4
case,, $
UserLoginFailedException,, -
ulfEx,,. 3
:,,3 4
code-- 
=-- 
HttpStatusCode-- )
.--) *

BadRequest--* 4
;--4 5
break.. 
;.. 
default// 
:// 
code00 
=00 
HttpStatusCode00 )
.00) *
InternalServerError00* =
;00= >
break11 
;11 
}22 
var44 
result44 
=44 
JsonConvert44 $
.44$ %
SerializeObject44% 4
(444 5
new445 8
{449 :
Erro44; ?
=44@ A
	exception44B K
.44K L
Message44L S
}44T U
)44U V
;44V W
context55 
.55 
Response55 
.55 
ContentType55 (
=55) *
$str55+ =
;55= >
context66 
.66 
Response66 
.66 

StatusCode66 '
=66( )
(66* +
int66+ .
)66. /
code66/ 3
;663 4
return77 
context77 
.77 
Response77 #
.77# $

WriteAsync77$ .
(77. /
result77/ 5
)775 6
;776 7
}88 	
}99 
}:: Ù
-D:\Dev\AspNetCoreTestes\App.WebAPI\Program.cs
	namespace 	
App
 
. 
WebAPI 
{ 
public 

class 
Program 
{ 
public 
static 
void 
Main 
(  
string  &
[& '
]' (
args) -
)- .
{ 	
Console 
. 
Title 
= 
$str !
;! "
var 
config 
= 
new  
ConfigurationBuilder 1
(1 2
)2 3
. 
SetBasePath 
( 
	Directory %
.% &
GetCurrentDirectory& 9
(9 :
): ;
); <
. 
AddJsonFile 
( 
$str .
,. /
optional0 8
:8 9
false: ?
)? @
. 
Build 
( 
) 
; 
var 
host 
= 
new 
WebHostBuilder )
() *
)* +
. 

UseKestrel 
( 
) 
. 
UseConfiguration !
(! "
config" (
)( )
.   
UseUrls   
(   
$str   0
)  0 1
.!! 
UseContentRoot!! 
(!!  
	Directory!!  )
.!!) *
GetCurrentDirectory!!* =
(!!= >
)!!> ?
)!!? @
."" 
UseIISIntegration"" "
(""" #
)""# $
.## 

UseStartup## 
<## 
Startup## #
>### $
(##$ %
)##% &
.$$ 
Build$$ 
($$ 
)$$ 
;$$ 
host&& 
.&& 
Run&& 
(&& 
)&& 
;&& 
}'' 	
public.. 
static.. 
IWebHost.. 
BuildWebHost.. +
(..+ ,
string.., 2
[..2 3
]..3 4
args..5 9
)..9 :
=>..; =
WebHost// 
.//  
CreateDefaultBuilder// (
(//( )
args//) -
)//- .
.00 

UseStartup00 
<00 
Startup00 #
>00# $
(00$ %
)00% &
.11 
Build11 
(11 
)11 
;11 
}22 
}33 Ó±
-D:\Dev\AspNetCoreTestes\App.WebAPI\Startup.cs
	namespace&& 	
App&&
 
.&& 
WebAPI&& 
{'' 
public++ 

class++ 
Startup++ 
{,, 
private-- 
readonly-- 
	Container-- "
	container--# ,
=--- .
ContainerFactory--/ ?
.--? @
	Container--@ I
;--I J
private// 
IConfigurationRoot// "
_config//# *
;//* +
public55 
Startup55 
(55 
IConfiguration55 %
configuration55& 3
)553 4
{66 	
Configuration77 
=77 
configuration77 )
;77) *
}88 	
public== 
IConfiguration== 
Configuration== +
{==, -
get==. 1
;==1 2
}==3 4
publicCC 
voidCC 
ConfigureServicesCC %
(CC% &
IServiceCollectionCC& 8
servicesCC9 A
)CCA B
{DD 	
servicesEE 
.EE 
AddMvcEE 
(EE 
)EE 
;EE 
servicesII 
.II 
AddAuthenticationII &
(II& '
(II' (
optionsII( /
)II/ 0
=>II1 3
{JJ 
optionsKK 
.KK 
DefaultSchemeKK %
=KK& '
JwtBearerDefaultsKK( 9
.KK9 : 
AuthenticationSchemeKK: N
;KKN O
optionsLL 
.LL "
DefaultChallengeSchemeLL .
=LL/ 0
JwtBearerDefaultsLL1 B
.LLB C 
AuthenticationSchemeLLC W
;LLW X
}MM 
)MM 
.NN 
AddJwtBearerNN 
(NN 
optionsNN !
=>NN" $
{OO 
optionsPP 
.PP %
TokenValidationParametersPP 1
=PP2 3
newPP4 7%
TokenValidationParametersPP8 Q
(PPQ R
)PPR S
{QQ 
ValidIssuerRR 
=RR  !
ConfigurationRR" /
[RR/ 0
$strRR0 ?
]RR? @
,RR@ A
ValidAudienceSS !
=SS" #
ConfigurationSS$ 1
[SS1 2
$strSS2 C
]SSC D
,SSD E
IssuerSigningKeyTT $
=TT% &
newTT' * 
SymmetricSecurityKeyTT+ ?
(TT? @
EncodingTT@ H
.TTH I
UTF8TTI M
.TTM N
GetBytesTTN V
(TTV W
ConfigurationTTW d
[TTd e
$strTTe q
]TTq r
)TTr s
)TTs t
}UU 
;UU 
optionsVV 
.VV  
RequireHttpsMetadataVV ,
=VV- .
falseVV/ 4
;VV4 5
optionsWW 
.WW 
	SaveTokenWW !
=WW" #
trueWW$ (
;WW( )
optionsXX 
.XX 
AudienceXX  
=XX! "
ConfigurationXX# 0
[XX0 1
$strXX1 B
]XXB C
;XXC D
}YY 
)YY 
;YY 
services[[ 
.[[ 
AddAuthorization[[ %
([[% &
options[[& -
=>[[. 0
{\\ 
options]] 
.]] 
	AddPolicy]] !
(]]! "
$str]]" 3
,]]3 4
p]]5 6
=>]]7 9
p]]: ;
.]]; <
RequireClaim]]< H
(]]H I
$str]]I R
,]]R S
PerfilUsuario]]T a
.]]a b
Administradores]]b q
.]]q r
ToString]]r z
(]]z {
)]]{ |
)]]| }
)]]} ~
;]]~ 
}^^ 
)^^ 
;^^ #
IntegrateSimpleInjectorbb #
(bb# $
servicesbb$ ,
)bb, -
;bb- .
servicesee 
.ee 
AddSwaggerGenee "
(ee" #
optionsee# *
=>ee+ -
{ff 
optionsgg 
.gg 

SwaggerDocgg "
(gg" #
$strgg# '
,gg' (
newgg) ,
Infogg- 1
{hh 
Versionii 
=ii 
$strii "
,ii" #
Titlejj 
=jj 
$strjj 1
,jj1 2
Descriptionkk 
=kk  !
$strkk" [
,kk[ \
TermsOfServicell "
=ll# $
$strll% +
,ll+ ,
Contactmm 
=mm 
newmm !
Contactmm" )
{mm* +
Namemm, 0
=mm1 2
$strmm3 F
,mmF G
EmailmmH M
=mmN O
$strmmP i
,mmi j
Urlmmk n
=mmo p
$strmmq s
}mmt u
}nn 
)nn 
;nn 
varqq 
basePathqq 
=qq 
PlatformServicesqq /
.qq/ 0
Defaultqq0 7
.qq7 8
Applicationqq8 C
.qqC D
ApplicationBasePathqqD W
;qqW X
varrr 
xmlPathrr 
=rr 
Pathrr "
.rr" #
Combinerr# *
(rr* +
basePathrr+ 3
,rr3 4
$strrr5 E
)rrE F
;rrF G
optionsss 
.ss 
IncludeXmlCommentsss *
(ss* +
xmlPathss+ 2
)ss2 3
;ss3 4
optionstt 
.tt 
OperationFiltertt '
<tt' (.
"AuthorizationHeaderOperationFiltertt( J
>ttJ K
(ttK L
)ttL M
;ttM N
}uu 
)uu 
;uu 
}yy 	
private{{ 
void{{ #
IntegrateSimpleInjector{{ ,
({{, -
IServiceCollection{{- ?
services{{@ H
){{H I
{|| 	
	container}} 
.}} 
Options}} 
.}} "
DefaultScopedLifestyle}} 4
=}}5 6
new}}7 : 
AsyncScopedLifestyle}}; O
(}}O P
)}}P Q
;}}Q R
services 
. 
AddSingleton !
<! " 
IHttpContextAccessor" 6
,6 7
HttpContextAccessor8 K
>K L
(L M
)M N
;N O
services
 
.
 
AddSingleton
 !
<
! ""
IControllerActivator
" 6
>
6 7
(
7 8
new
 /
!SimpleInjectorControllerActivator
 5
(
5 6
	container
6 ?
)
? @
)
@ A
;
A B
services
 
.
 
AddSingleton
 !
<
! "%
IViewComponentActivator
" 9
>
9 :
(
: ;
new
 2
$SimpleInjectorViewComponentActivator
 8
(
8 9
	container
9 B
)
B C
)
C D
;
D E
services
 
.
 -
EnableSimpleInjectorCrossWiring
 4
(
4 5
	container
5 >
)
> ?
;
? @
services
 
.
 3
%UseSimpleInjectorAspNetRequestScoping
 :
(
: ;
	container
; D
)
D E
;
E F
}
 	
public
 
void
 
	Configure
 
(
 !
IApplicationBuilder
 1
app
2 5
,
5 6!
IHostingEnvironment
7 J
env
K N
)
N O
{
 	
var
 
builder
 
=
 
new
 "
ConfigurationBuilder
 2
(
2 3
)
3 4
.
 
SetBasePath
 
(
 
env
 
.
 
ContentRootPath
 .
)
. /
.
 
AddJsonFile
 
(
 
$str
 -
,
- .
optional
/ 7
:
7 8
true
9 =
,
= >
reloadOnChange
? M
:
M N
true
O S
)
S T
.
 
AddJsonFile
 
(
 
$"
 
appsettings.
 )
{
) *
env
* -
.
- .
EnvironmentName
. =
}
= >
.json
> C
"
C D
,
D E
optional
F N
:
N O
true
P T
)
T U
.
 %
AddEnvironmentVariables
 &
(
& '
)
' (
;
( )
_config
 
=
 
builder
 
.
 
Build
 #
(
# $
)
$ %
;
% &!
InitializeContainer
 
(
  
app
  #
)
# $
;
$ %
	container
   
.
   
Register
   
<
   "
ApiRequestMiddleware
   3
>
  3 4
(
  4 5
)
  5 6
;
  6 7
	container
¡¡ 
.
¡¡ 
Register
¡¡ 
<
¡¡ $
ErrorHandlerMiddleware
¡¡ 5
>
¡¡5 6
(
¡¡6 7
)
¡¡7 8
;
¡¡8 9
	container
££ 
.
££ 
Verify
££ 
(
££ 
)
££ 
;
££ 
app
¨¨ 
.
¨¨ 
Use
¨¨ 
(
¨¨ 
(
¨¨ 
c
¨¨ 
,
¨¨ 
next
¨¨ 
)
¨¨ 
=>
¨¨  
	container
¨¨! *
.
¨¨* +
GetInstance
¨¨+ 6
<
¨¨6 7"
ApiRequestMiddleware
¨¨7 K
>
¨¨K L
(
¨¨L M
)
¨¨M N
.
¨¨N O
Invoke
¨¨O U
(
¨¨U V
c
¨¨V W
,
¨¨W X
next
¨¨Y ]
)
¨¨] ^
)
¨¨^ _
;
¨¨_ `
app
©© 
.
©© 
Use
©© 
(
©© 
(
©© 
c
©© 
,
©© 
next
©© 
)
©© 
=>
©©  
	container
©©! *
.
©©* +
GetInstance
©©+ 6
<
©©6 7$
ErrorHandlerMiddleware
©©7 M
>
©©M N
(
©©N O
)
©©O P
.
©©P Q
Invoke
©©Q W
(
©©W X
c
©©X Y
,
©©Y Z
next
©©[ _
)
©©_ `
)
©©` a
;
©©a b
app
®® 
.
®® 

UseSwagger
®® 
(
®® 
)
®® 
;
®® 
app
°° 
.
°° 
UseSwaggerUI
°° 
(
°° 
c
°° 
=>
°° !
{
±± 
c
²² 
.
²² 
SwaggerEndpoint
²² !
(
²²! "
$str
²²" <
,
²²< =
$str
²²> Z
)
²²Z [
;
²²[ \
}
³³ 
)
³³ 
;
³³ 
app
¸¸ 
.
¸¸ 
UseAuthentication
¸¸ !
(
¸¸! "
)
¸¸" #
;
¸¸# $
app
»» 
.
»» $
UseMvcWithDefaultRoute
»» &
(
»»& '
)
»»' (
;
»»( )
}
¼¼ 	
private
¾¾ 
void
¾¾ !
InitializeContainer
¾¾ (
(
¾¾( )!
IApplicationBuilder
¾¾) <
app
¾¾= @
)
¾¾@ A
{
¿¿ 	
	container
ÁÁ 
.
ÁÁ $
RegisterMvcControllers
ÁÁ ,
(
ÁÁ, -
app
ÁÁ- 0
)
ÁÁ0 1
;
ÁÁ1 2
	container
ÂÂ 
.
ÂÂ '
RegisterMvcViewComponents
ÂÂ /
(
ÂÂ/ 0
app
ÂÂ0 3
)
ÂÂ3 4
;
ÂÂ4 5
	container
ÅÅ 
.
ÅÅ 
RegisterSingleton
ÅÅ '
(
ÅÅ' (
typeof
ÅÅ( .
(
ÅÅ. / 
IConfigurationRoot
ÅÅ/ A
)
ÅÅA B
,
ÅÅB C
_config
ÅÅD K
)
ÅÅK L
;
ÅÅL M
	container
ÆÆ 
.
ÆÆ 
RegisterSingleton
ÆÆ '
<
ÆÆ' ("
IHttpContextAccessor
ÆÆ( <
,
ÆÆ< =!
HttpContextAccessor
ÆÆ> Q
>
ÆÆQ R
(
ÆÆR S
)
ÆÆS T
;
ÆÆT U
	container
ÉÉ 
.
ÉÉ 
Register
ÉÉ 
<
ÉÉ (
IUsuarioApplicationService
ÉÉ 9
,
ÉÉ9 :'
UsuarioApplicationService
ÉÉ; T
>
ÉÉT U
(
ÉÉU V
	Lifestyle
ÉÉV _
.
ÉÉ_ `
Scoped
ÉÉ` f
)
ÉÉf g
;
ÉÉg h
	container
ÊÊ 
.
ÊÊ 
Register
ÊÊ 
<
ÊÊ '
IPedidoApplicationService
ÊÊ 8
,
ÊÊ8 9&
PedidoApplicationService
ÊÊ: R
>
ÊÊR S
(
ÊÊS T
	Lifestyle
ÊÊT ]
.
ÊÊ] ^
Scoped
ÊÊ^ d
)
ÊÊd e
;
ÊÊe f
	container
ËË 
.
ËË 
Register
ËË 
<
ËË (
IClienteApplicationService
ËË 9
,
ËË9 :'
ClienteApplicationService
ËË; T
>
ËËT U
(
ËËU V
	Lifestyle
ËËV _
.
ËË_ `
Scoped
ËË` f
)
ËËf g
;
ËËg h
	container
ÌÌ 
.
ÌÌ 
Register
ÌÌ 
<
ÌÌ &
ILoginApplicationService
ÌÌ 7
,
ÌÌ7 8%
LoginApplicationService
ÌÌ9 P
>
ÌÌP Q
(
ÌÌQ R
	Lifestyle
ÌÌR [
.
ÌÌ[ \
Scoped
ÌÌ\ b
)
ÌÌb c
;
ÌÌc d
	container
ÐÐ 
.
ÐÐ 
Register
ÐÐ 
<
ÐÐ  
IUsuarioRepository
ÐÐ 1
,
ÐÐ1 2
UsuarioRepository
ÐÐ3 D
>
ÐÐD E
(
ÐÐE F
	Lifestyle
ÐÐF O
.
ÐÐO P
Scoped
ÐÐP V
)
ÐÐV W
;
ÐÐW X
	container
ÑÑ 
.
ÑÑ 
Register
ÑÑ 
<
ÑÑ 
IPedidoRepository
ÑÑ 0
,
ÑÑ0 1
PedidoRepository
ÑÑ2 B
>
ÑÑB C
(
ÑÑC D
	Lifestyle
ÑÑD M
.
ÑÑM N
Scoped
ÑÑN T
)
ÑÑT U
;
ÑÑU V
	container
ÒÒ 
.
ÒÒ 
Register
ÒÒ 
<
ÒÒ  
IProdutoRepository
ÒÒ 1
,
ÒÒ1 2
ProdutoRepository
ÒÒ3 D
>
ÒÒD E
(
ÒÒE F
	Lifestyle
ÒÒF O
.
ÒÒO P
Scoped
ÒÒP V
)
ÒÒV W
;
ÒÒW X
	container
ÓÓ 
.
ÓÓ 
Register
ÓÓ 
<
ÓÓ  
IClienteRepository
ÓÓ 1
,
ÓÓ1 2
ClienteRepository
ÓÓ3 D
>
ÓÓD E
(
ÓÓE F
	Lifestyle
ÓÓF O
.
ÓÓO P
Scoped
ÓÓP V
)
ÓÓV W
;
ÓÓW X
	container
ÔÔ 
.
ÔÔ 
Register
ÔÔ 
<
ÔÔ 
ITenantRepository
ÔÔ 0
,
ÔÔ0 1
TenantRepository
ÔÔ2 B
>
ÔÔB C
(
ÔÔC D
	Lifestyle
ÔÔD M
.
ÔÔM N
Scoped
ÔÔN T
)
ÔÔT U
;
ÔÔU V
	container
ØØ 
.
ØØ 
Register
ØØ 
(
ØØ 
(
ØØ  
)
ØØ  !
=>
ØØ" $
{
ÙÙ 
var
ÚÚ 
options
ÚÚ 
=
ÚÚ 
new
ÚÚ !%
DbContextOptionsBuilder
ÚÚ" 9
<
ÚÚ9 :
AdminContext
ÚÚ: F
>
ÚÚF G
(
ÚÚG H
)
ÚÚH I
;
ÚÚI J
options
ÛÛ 
.
ÛÛ 
UseSqlServer
ÛÛ $
(
ÛÛ$ % 
GetDatabaseForUser
ÛÛ% 7
(
ÛÛ7 8
)
ÛÛ8 9
)
ÛÛ9 :
;
ÛÛ: ;
return
ÜÜ 
new
ÜÜ 
AdminContext
ÜÜ '
(
ÜÜ' (
options
ÜÜ( /
.
ÜÜ/ 0
Options
ÜÜ0 7
)
ÜÜ7 8
;
ÜÜ8 9
}
ÝÝ 
,
ÝÝ 
	Lifestyle
ÝÝ 
.
ÝÝ 
Scoped
ÝÝ 
)
ÝÝ  
;
ÝÝ  !
	container
ßß 
.
ßß 
Register
ßß 
(
ßß 
(
ßß  
)
ßß  !
=>
ßß" $
{
àà 
var
áá 
options
áá 
=
áá 
new
áá !%
DbContextOptionsBuilder
áá" 9
<
áá9 :
LojaContext
áá: E
>
ááE F
(
ááF G
)
ááG H
;
ááH I
options
ââ 
.
ââ 
UseSqlServer
ââ $
(
ââ$ % 
GetDatabaseForUser
ââ% 7
(
ââ7 8
)
ââ8 9
)
ââ9 :
;
ââ: ;
return
ãã 
new
ãã 
LojaContext
ãã &
(
ãã& '
options
ãã' .
.
ãã. /
Options
ãã/ 6
)
ãã6 7
;
ãã7 8
}
ää 
,
ää 
	Lifestyle
ää 
.
ää 
Scoped
ää 
)
ää  
;
ää  !
	container
ææ 
.
ææ 
Register
ææ 
(
ææ 
(
ææ  
)
ææ  !
=>
ææ" $
{
çç 
var
èè 
options
èè 
=
èè 
new
èè !%
DbContextOptionsBuilder
èè" 9
<
èè9 :%
TenantManagementContext
èè: Q
>
èèQ R
(
èèR S
)
èèS T
;
èèT U
options
éé 
.
éé 
UseSqlServer
éé $
(
éé$ %
Configuration
éé% 2
.
éé2 3!
GetConnectionString
éé3 F
(
ééF G
$str
ééG P
)
ééP Q
)
ééQ R
;
ééR S
return
êê 
new
êê %
TenantManagementContext
êê 2
(
êê2 3
options
êê3 :
.
êê: ;
Options
êê; B
)
êêB C
;
êêC D
}
ëë 
,
ëë 
	Lifestyle
ëë 
.
ëë 
Scoped
ëë 
)
ëë  
;
ëë  !
Assembly
ïï 
[
ïï 
]
ïï 

assemblies
ïï !
=
ïï" #
new
ïï$ '
[
ïï' (
]
ïï( )
{
ïï* +
typeof
ðð 
(
ðð 
IHandle
ðð 
<
ðð  
>
ðð  !
)
ðð! "
.
ðð" #
GetTypeInfo
ðð# .
(
ðð. /
)
ðð/ 0
.
ðð0 1
Assembly
ðð1 9
,
ññ 
typeof
ññ 
(
ññ '
UsuarioCriadoEventHandler
ññ 1
)
ññ1 2
.
ññ2 3
GetTypeInfo
ññ3 >
(
ññ> ?
)
ññ? @
.
ññ@ A
Assembly
ññA I
,
òò 
typeof
òò 
(
òò 
Application
òò #
.
òò# $
EventHandlers
òò$ 1
.
òò1 2'
EmailPedidoEnviadoHandler
òò2 K
)
òòK L
.
òòL M
GetTypeInfo
òòM X
(
òòX Y
)
òòY Z
.
òòZ [
Assembly
òò[ c
,
óó 
typeof
óó 
(
óó 
Repositories
óó $
.
óó$ %
EventHandlers
óó% 2
.
óó2 3%
UserCreatedEventHandler
óó3 J
)
óóJ K
.
óóK L
GetTypeInfo
óóL W
(
óóW X
)
óóX Y
.
óóY Z
Assembly
óóZ b
}
ôô 
;
ôô 
	container
õõ 
.
õõ  
RegisterCollection
õõ (
(
õõ( )
typeof
õõ) /
(
õõ/ 0
IHandle
õõ0 7
<
õõ7 8
>
õõ8 9
)
õõ9 :
,
õõ: ;

assemblies
õõ< F
)
õõF G
;
õõG H
	container
øø 
.
øø 
RegisterSingleton
øø '
(
øø' (
(
øø( )
)
øø) *
=>
øø+ -
	container
øø. 7
.
øø7 8
GetInstance
øø8 C
<
øøC D
MapperProvider
øøD R
>
øøR S
(
øøS T
)
øøT U
.
øøU V
	GetMapper
øøV _
(
øø_ `
)
øø` a
)
øøa b
;
øøb c
	container
ûû 
.
ûû 
	CrossWire
ûû 
<
ûû  
ILoggerFactory
ûû  .
>
ûû. /
(
ûû/ 0
app
ûû0 3
)
ûû3 4
;
ûû4 5
}
üü 	
private
þþ 
string
þþ  
GetDatabaseForUser
þþ )
(
þþ) *
)
þþ* +
{
ÿÿ 	
var
 
tenant
 
=
  
ObterTenantUsuario
 +
(
+ ,
)
, -
;
- .
if
 
(
 
tenant
 
!=
 
null
 
)
 
{
 
var
 
cnn
 
=
 
Configuration
 '
.
' (!
GetConnectionString
( ;
(
; <
$str
< D
)
D E
;
E F
return
 
cnn
 
.
 
Replace
 "
(
" #
$str
# -
,
- .
tenant
/ 5
)
5 6
;
6 7
}
 
return
 
Configuration
  
.
  !!
GetConnectionString
! 4
(
4 5
$str
5 >
)
> ?
;
? @
}
 	
private
 
string
  
ObterTenantUsuario
 )
(
) *
)
* +
{
 	
var
 
httpContext
 
=
 
	container
 '
.
' (
GetInstance
( 3
<
3 4"
IHttpContextAccessor
4 H
>
H I
(
I J
)
J K
;
K L
if
 
(
 
httpContext
 
.
 
HttpContext
 '
==
( *
null
+ /
||
 
httpContext
 
.
 
HttpContext
 *
.
* +
User
+ /
==
0 2
null
3 7
||
 
httpContext
 
.
 
HttpContext
 *
.
* +
User
+ /
.
/ 0
Identity
0 8
==
9 ;
null
< @
)
@ A
return
 
null
 
;
 
if
 
(
 
httpContext
 
.
 
HttpContext
 '
.
' (
User
( ,
.
, -
Identity
- 5
is
6 8
ClaimsIdentity
9 G
identity
H P
)
P Q
{
 
var
 
claims
 
=
 
identity
 %
.
% &
Claims
& ,
.
, -
ToList
- 3
(
3 4
)
4 5
;
5 6
var
 
claim
 
=
 
claims
 "
.
" #
FirstOrDefault
# 1
(
1 2
c
2 3
=>
4 6
c
7 8
.
8 9
Type
9 =
==
> @

ClaimTypes
A K
.
K L
Email
L Q
)
Q R
;
R S
return
 
claim
 
?
 
.
 
Value
 #
.
# $
Split
$ )
(
) *
$char
* -
)
- .
[
. /
$num
/ 0
]
0 1
;
1 2
}
 
return
 
null
 
;
 
}
   	
}
¡¡ 
}¢¢ Ï
PD:\Dev\AspNetCoreTestes\App.WebAPI\Swagger\AuthorizationHeaderOperationFilter.cs
	namespace 	
App
 
. 
WebAPI 
. 
Swagger 
{ 
public 

class .
"AuthorizationHeaderOperationFilter 3
:4 5
IOperationFilter6 F
{ 
public 
void 
Apply 
( 
	Operation #
	operation$ -
,- ."
OperationFilterContext/ E
contextF M
)M N
{ 	
var 
filterPipeline 
=  
context! (
.( )
ApiDescription) 7
.7 8
ActionDescriptor8 H
.H I
FilterDescriptorsI Z
;Z [
var 
isAuthorized 
= 
filterPipeline -
.- .
Select. 4
(4 5

filterInfo5 ?
=>@ B

filterInfoC M
.M N
FilterN T
)T U
.U V
AnyV Y
(Y Z
filterZ `
=>a c
filterd j
isk m
AuthorizeFiltern }
)} ~
;~ 
var 
allowAnonymous 
=  
filterPipeline! /
./ 0
Select0 6
(6 7

filterInfo7 A
=>B D

filterInfoE O
.O P
FilterP V
)V W
.W X
AnyX [
([ \
filter\ b
=>c e
filterf l
ism o"
IAllowAnonymousFilter	p 
)
 
;
 
if 
( 
isAuthorized 
&& 
!  !
allowAnonymous! /
)/ 0
{ 
if 
( 
	operation 
. 

Parameters (
==) +
null, 0
)0 1
	operation 
. 

Parameters (
=) *
new+ .
List/ 3
<3 4

IParameter4 >
>> ?
(? @
)@ A
;A B
	operation 
. 

Parameters $
.$ %
Add% (
(( )
new) ,
NonBodyParameter- =
{ 
Name   
=   
$str   *
,  * +
In!! 
=!! 
$str!! !
,!!! "
Description"" 
=""  !
$str""" <
,""< =
Required## 
=## 
true## #
,### $
Type$$ 
=$$ 
$str$$ #
}%% 
)%% 
;%% 
}&& 
}'' 	
}(( 
})) Æ
?D:\Dev\AspNetCoreTestes\App.WebAPI\ViewModels\LoginViewModel.cs
	namespace 	
App
 
. 
WebAPI 
. 

ViewModels 
{ 
public 

class 
LoginViewModel 
{		 
[ 	
Required	 
] 
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
[ 	
Required	 
] 
public 
string 
Senha 
{ 
get !
;! "
set# &
;& '
}( )
} 
} 